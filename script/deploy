#!/bin/bash

set -e # If anything fails, stop the script.
set -u # If an undefined variable is expanded, stop the script.

function sync_s3() {
  local src="${1}"
  local dest="${2}"

  aws s3 sync --content-encoding 'gzip' \
              --cache-control max-age=604800 \
              --acl public-read \
              --delete \
              "${src}" \
              "${dest}"
}

root="$(git rev-parse --show-toplevel)"

cd "${root}"

source .env

export AWS_DEFAULT_PROFILE="${AWS_DEFAULT_PROFILE}"

./script/build

find dist -name .DS_Store -delete
find dist -type f -exec gzip -9 '{}' \; -exec mv '{}.gz' '{}' \;

sync_s3 dist s3://pomodoro-timer

aws cloudfront create-invalidation \
  --distribution-id "${AWS_CLOUDFRONT_DISTRIBUTION_ID}" \
  --paths '/*'
